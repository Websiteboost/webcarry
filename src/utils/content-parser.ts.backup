import type { SiteContent, Game, Category, Service, PaymentMethod } from '../types';
import fs from 'fs';
import path from 'path';

// Función para parsear el archivo MD
function parseConfigMD(): SiteContent {
  const configPath = path.join(process.cwd(), 'src', 'content', 'config.md');
  const content = fs.readFileSync(configPath, 'utf-8');
  
  const lines = content.split('\n');
  
  const siteContent: SiteContent = {
    home: {
      title: '',
      subtitle: '',
      categories: []
    },
    games: [],
    categories: [],
    services: [],
    paymentMethods: []
  };

  let currentSection = '';
  let currentGame: Partial<Game> = {};
  let currentCategory: Partial<Category> & { services?: any[] } = {};
  let currentService: Partial<Service> & { description?: string[] } = {};
  let currentPaymentMethod: Partial<PaymentMethod> = {};

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();

    if (line.startsWith('## Home Information') || line.startsWith('## Información del Home')) {
      currentSection = 'home';
    } else if (line.startsWith('## Available Games') || line.startsWith('## Juegos Disponibles')) {
      currentSection = 'games';
    } else if (line.startsWith('## Service Categories') || line.startsWith('## Categorías de Servicios')) {
      currentSection = 'categories';
    } else if (line.startsWith('## Services') || line.startsWith('## Servicios')) {
      currentSection = 'services';
    } else if (line.startsWith('## Payment Methods') || line.startsWith('## Métodos de Pago')) {
      currentSection = 'payment-methods';
    }

    // Home section
    if (currentSection === 'home') {
      if (line.startsWith('### Main Title') || line.startsWith('### Título Principal')) {
        if (i + 1 < lines.length) siteContent.home.title = lines[++i].trim();
      } else if (line.startsWith('### Subtitle') || line.startsWith('### Subtítulo')) {
        if (i + 1 < lines.length) siteContent.home.subtitle = lines[++i].trim();
      } else if (line.startsWith('### Featured Categories') || line.startsWith('### Categorías Destacadas')) {
        i++;
        while (i < lines.length && lines[i] && lines[i].trim().startsWith('-')) {
          siteContent.home.categories.push(lines[i].trim().substring(2));
          i++;
        }
      }
    }

    // Games section
    if (currentSection === 'games' && (line.startsWith('### Game') || line.startsWith('### Juego'))) {
      currentGame = {};
      while (i < lines.length - 1 && !lines[i + 1]?.startsWith('###') && !lines[i + 1]?.startsWith('##')) {
        i++;
        if (!lines[i]) continue;
        const gameLine = lines[i].trim();
        if (gameLine.startsWith('- **ID**:')) {
          currentGame.id = gameLine.split(':')[1].trim();
        } else if (gameLine.startsWith('- **Title**:') || gameLine.startsWith('- **Título**:')) {
          currentGame.title = gameLine.split(':')[1].trim();
        } else if (gameLine.startsWith('- **Category**:') || gameLine.startsWith('- **Categoría**:')) {
          currentGame.category = gameLine.split(':')[1].trim();
        } else if (gameLine.startsWith('- **Image**:') || gameLine.startsWith('- **Imagen**:')) {
          currentGame.image = gameLine.split(':')[1].trim();
        }
        if (currentGame.id && currentGame.title && currentGame.image && currentGame.category) {
          siteContent.games.push(currentGame as Game);
          currentGame = {};
        }
      }
    }

    // Categories section
    if (currentSection === 'categories' && (line.startsWith('### Category') || line.startsWith('### Categoría'))) {
      currentCategory = { services: [] };
      while (i < lines.length - 1 && !lines[i + 1]?.startsWith('###') && !lines[i + 1]?.startsWith('##')) {
        i++;
        if (!lines[i]) continue;
        const catLine = lines[i].trim();
        if (catLine.startsWith('- **ID**:')) {
          currentCategory.id = catLine.split(':')[1].trim();
        } else if (catLine.startsWith('- **Name**:') || catLine.startsWith('- **Nombre**:')) {
          currentCategory.name = catLine.split(':')[1].trim();
        } else if (catLine.startsWith('- **Description**:') || catLine.startsWith('- **Descripción**:')) {
          currentCategory.description = catLine.substring(catLine.indexOf(':') + 1).trim();
        } else if (catLine.startsWith('- **Icon**:') || catLine.startsWith('- **Icono**:')) {
          currentCategory.icon = catLine.split(':')[1].trim();
        }
        if (currentCategory.id && currentCategory.name && currentCategory.description && currentCategory.icon) {
          siteContent.categories.push(currentCategory as Category);
          currentCategory = { services: [] };
        }
      }
    }

    // Services section
    if (currentSection === 'services' && (line.includes('Service') || line.startsWith('### Servicio'))) {
      currentService = { description: [] };
      while (i < lines.length - 1 && !lines[i + 1]?.startsWith('###') && !lines[i + 1]?.startsWith('##')) {
        i++;
        if (!lines[i]) continue;
        const servLine = lines[i].trim();
        if (servLine.startsWith('- **ID**:')) {
          currentService.id = servLine.split(':')[1].trim();
        } else if (servLine.startsWith('- **Title**:') || servLine.startsWith('- **Título**:')) {
          currentService.title = servLine.split(':')[1].trim();
        } else if (servLine.startsWith('- **Category**:') || servLine.startsWith('- **Categoría**:')) {
          currentService.categoryId = servLine.split(':')[1].trim();
        } else if (servLine.startsWith('- **Price**:') || servLine.startsWith('- **Precio**:')) {
          currentService.price = parseInt(servLine.split(':')[1].trim());
        } else if (servLine.startsWith('- **Image**:') || servLine.startsWith('- **Imagen**:')) {
          currentService.image = servLine.split(':')[1].trim();
        } else if (servLine.startsWith('- **Description**:') || servLine.startsWith('- **Descripción**:')) {
          i++;
          while (i < lines.length && lines[i] && lines[i].trim().startsWith('-')) {
            currentService.description?.push(lines[i].trim().substring(2));
            i++;
          }
          i--;
        }
        if (currentService.id && currentService.title && currentService.categoryId && currentService.price && currentService.image && currentService.description) {
          siteContent.services.push(currentService as Service);
          
          // Agregar servicio a su categoría
          const category = siteContent.categories.find(c => c.id === currentService.categoryId);
          if (category) {
            if (!category.services) {
              category.services = [];
            }
            category.services.push(currentService as Service);
          }
          
          currentService = { description: [] };
        }
      }
    }

    // Payment Methods section
    if (currentSection === 'payment-methods' && line.startsWith('###') && !line.includes('Payment Methods') && !line.includes('Métodos de Pago')) {
      currentPaymentMethod = {};
      const name = line.replace('###', '').trim();
      currentPaymentMethod.name = name;
      while (i < lines.length - 1 && !lines[i + 1]?.startsWith('###') && !lines[i + 1]?.startsWith('##')) {
        i++;
        if (!lines[i]) continue;
        const pmLine = lines[i].trim();
        if (pmLine.startsWith('- **ID**:')) {
          currentPaymentMethod.id = pmLine.split(':')[1].trim();
        } else if (pmLine.startsWith('- **Name**:') || pmLine.startsWith('- **Nombre**:')) {
          currentPaymentMethod.name = pmLine.split(':')[1].trim();
        } else if (pmLine.startsWith('- **Icon**:') || pmLine.startsWith('- **Icono**:')) {
          currentPaymentMethod.icon = pmLine.split(':')[1].trim();
        }
        if (currentPaymentMethod.id && currentPaymentMethod.name && currentPaymentMethod.icon) {
          siteContent.paymentMethods.push(currentPaymentMethod as PaymentMethod);
          currentPaymentMethod = {};
        }
      }
    }
  }

  return siteContent;
}

// Exportar función para obtener el contenido
export function getSiteContent(): SiteContent {
  return parseConfigMD();
}

// Exportar funciones auxiliares
export function getGameById(id: string): Game | undefined {
  const content = getSiteContent();
  return content.games.find(game => game.id === id);
}

export function getCategoryById(id: string): Category | undefined {
  const content = getSiteContent();
  return content.categories.find(cat => cat.id === id);
}

export function getServiceById(id: string): Service | undefined {
  const content = getSiteContent();
  return content.services.find(service => service.id === id);
}

export function getServicesByCategory(categoryId: string): Service[] {
  const content = getSiteContent();
  return content.services.filter(service => service.categoryId === categoryId);
}
