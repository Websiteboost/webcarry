---
import MainLayout from '../../layouts/MainLayout.astro';
import Footer from '../../components/astro/Footer.astro';
import Breadcrumb from '../../components/astro/Breadcrumb.astro';
import CategorySidebar from '../../components/react/CategorySidebar';
import ServiceGrid from '../../components/react/ServiceGrid';
import MobileMenu from '../../components/react/MobileMenu';
import GlitchLogo from '../../components/astro/GlitchLogo.astro';
import BackgroundLogo from '../../components/astro/BackgroundLogo.astro';
import { 
  getSiteContent, 
  getGameById, 
  getServicesByGame,
  getCategoriesWithServicesByGame,
  getPaymentConfig
} from '../../lib/services';

// Modo SSR dinámico - consulta DB en cada request
const { id } = Astro.params;
const game = await getGameById(id as string);

if (!game) {
  return Astro.redirect('/');
}

// Obtener servicios específicos de este juego desde la DB
const gameServices = await getServicesByGame(game.id);

// Obtener categorías filtradas por este juego con sus servicios
const gameCategories = await getCategoriesWithServicesByGame(game.id);

// Obtener accordion para la UI
const siteContent = await getSiteContent();
const { accordion, home } = siteContent;

// Obtener configuración de pago
const paymentConfig = await getPaymentConfig();

const breadcrumbPath = [
  { name: 'Home', url: '/' },
  { name: game.title, url: `/game/${game.id}` },
  { name: 'Services', url: `/game/${game.id}` }
];
---

<MainLayout title={`${game.title} - ${home.title}`}>
  <!-- Logo: top-right inicial en mobile, bottom-left con scroll; top-left fixed en desktop -->
  <div id="game-logo" class="fixed top-6 right-6 z-50 p-3 sm:top-0 sm:left-0 sm:right-auto sm:p-6">
    <div class="transition-all duration-700 ease-in-out opacity-100">
      <GlitchLogo logoText={home.logoText} />
    </div>
  </div>
  
  <!-- Mobile Menu -->
  <MobileMenu client:load categories={gameCategories as any} />

  <main class="min-h-screen pt-24 pb-8 relative">
    <!-- Background BB Watermark -->
    <BackgroundLogo />

    <div class="w-full max-w-full overflow-x-hidden relative z-10">
      <!-- Main Content -->
      <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- Sidebar (Desktop) - Full Height -->
        <div class="hidden lg:block lg:w-80 shrink-0">
          <CategorySidebar client:load categories={gameCategories as any} />
        </div>

        <!-- Content Area with more spacing -->
        <div class="flex-1 px-6 lg:px-10 py-8 lg:py-12">
          <!-- Breadcrumb moved here -->
          <div class="mb-8">
            <Breadcrumb path={breadcrumbPath} />
          </div>
          
          <!-- Page Header -->
          <div class="mb-12">
            <h1 class="text-4xl lg:text-5xl font-bold mb-4">
              <span class="text-cyber-white">{game.title}</span>
              <span class="neon-text ml-3">Services</span>
            </h1>
            <p class="text-cyber-white/70 text-lg leading-relaxed max-w-3xl">
              Explore our professional services for {game.title}. Select the category you need and enhance your gaming experience.
            </p>
          </div>

          <!-- Services Grid -->
          <ServiceGrid client:load initialServices={gameServices} accordionContent={accordion} categories={gameCategories as any} paymentDisclaimer={paymentConfig.disclaimer} />
        </div>
      </div>
    </div>
  </main>

  <Footer />
</MainLayout>

<script>
  let lastScrollY = 0;
  const logo = document.getElementById('game-logo');

  const updateLogoBackground = () => {
    const currentScrollY = window.scrollY;
    
    if (currentScrollY > 50) {
      logo?.classList.add('logo-with-bg');
    } else {
      logo?.classList.remove('logo-with-bg');
    }
    
    lastScrollY = currentScrollY;
  };

  // Verificar posición inicial al cargar
  updateLogoBackground();

  // Actualizar al hacer scroll
  window.addEventListener('scroll', updateLogoBackground);
</script>

<style>
  #game-logo {
    border: none;
    outline: none;
  }

  #game-logo.logo-with-bg {
    background: linear-gradient(135deg, rgba(26, 11, 46, 0.75) 0%, rgba(22, 33, 62, 0.75) 100%);
    backdrop-filter: blur(10px);
    border: none !important;
    outline: none !important;
    border-bottom: 1px solid rgba(168, 85, 247, 0.15);
    border-right: 1px solid rgba(168, 85, 247, 0.15);
    border-bottom-right-radius: 1rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }

  #game-logo.logo-with-bg::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image: 
      radial-gradient(circle at 20% 30%, rgba(107, 33, 168, 0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(14, 165, 233, 0.12) 0%, transparent 50%);
    border-bottom-right-radius: 1rem;
    border: none;
    pointer-events: none;
    z-index: -1;
  }

  #game-logo.logo-with-bg::after {
    content: '';
    position: absolute;
    inset: 0;
    background-image: 
      radial-gradient(circle at 25% 25%, rgba(168, 85, 247, 0.08) 0, transparent 3px),
      radial-gradient(circle at 75% 75%, rgba(56, 189, 248, 0.08) 0, transparent 3px);
    background-size: 30px 30px;
    background-position: 0 0, 15px 15px;
    border-bottom-right-radius: 1rem;
    border: none;
    pointer-events: none;
    z-index: -1;
  }
</style>

<script>
  // Script optimizado para cambiar posición del logo en mobile al hacer scroll con fade suave
  document.addEventListener('DOMContentLoaded', () => {
    const logo = document.getElementById('game-logo');
    const logoInner = logo?.querySelector('div');
    
    if (logo && logoInner) {
      // Asegurar que el logo siempre tenga opacity 1 por defecto
      logoInner.style.opacity = '1';
      
      if (window.innerWidth < 640) { // Solo en mobile (sm breakpoint)
        let ticking = false;
        let lastScrollY = 0;
        
        const updateLogoPosition = () => {
          const scrollY = window.scrollY;
          
          if (scrollY > 100 && lastScrollY <= 100) {
            // Fade out primero
            logoInner.style.opacity = '0';
            
            // Después de 350ms cambiar posición y fade in
            setTimeout(() => {
              logo.classList.remove('top-6', 'right-6');
              logo.classList.add('bottom-0', 'left-0', 'glass-effect', 'rounded-tr-lg');
              
              // Fade in
              setTimeout(() => {
                logoInner.style.opacity = '1';
              }, 50);
            }, 350);
            
          } else if (scrollY <= 100 && lastScrollY > 100) {
            // Fade out primero
            logoInner.style.opacity = '0';
            
            // Después de 350ms cambiar posición y fade in
            setTimeout(() => {
              logo.classList.remove('bottom-0', 'left-0', 'glass-effect', 'rounded-tr-lg');
              logo.classList.add('top-6', 'right-6');
              
              // Fade in
              setTimeout(() => {
                logoInner.style.opacity = '1';
              }, 50);
            }, 350);
          }
          
          lastScrollY = scrollY;
          ticking = false;
        };
        
        const onScroll = () => {
          if (!ticking) {
            requestAnimationFrame(updateLogoPosition);
            ticking = true;
          }
        };
        
        window.addEventListener('scroll', onScroll, { passive: true });
      }
    }
  });
</script>
</MainLayout>
